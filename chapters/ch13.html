<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Log shipping and other fun activities</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
.footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
.footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_log_shipping_and_other_fun_activities">Log shipping and other fun activities</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Log shipping allows us to have a primary database as well as secondary one (or multiple secondaries). There are several reasons why you&#8217;ll want to use log shipping:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To enable high availability.</p>
</li>
<li>
<p>To have multiple copies of the database.</p>
</li>
<li>
<p>For backup purposes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The core of the idea is simple. A database that uses a WAL is going to use the WAL to recover on startup. In other words, the WAL records all the actions that were
made on the database. What will happen if we took the same approach, but didn&#8217;t apply the WAL records on the database on startup, what happens if we&#8217;ll apply them
on <em>another</em> database?</p>
</div>
<div class="paragraph">
<p>The result of applying the WAL is going to be the same, so we&#8217;ll have another copy of the database in another location.
We can extend this idea to <em>store</em> the WAL records in some manner and then use them later of for backup purposes. Applying the WAL records on an empty file will
bring us up to the state as of the last transaction, after all.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Considerations for log shipping</div>
<div class="paragraph">
<p>I&#8217;m going to implement the skeleton of log shipping, the ability to intercept and replay the WAL records. What I&#8217;m <em>not</em> going to do is handle the distribution of
the data between databases. I&#8217;m leaving that entirely up to you.</p>
</div>
<div class="paragraph">
<p>I&#8217;ll say that you need to take into account the reliability of the mechanism that you use to send the data and the fact that there can only ever be a <em>single</em>
primary using this method. The transactions in the WAL must form a single log of operations that are applied in a consistent order across all the environments
that you use.</p>
</div>
<div class="paragraph">
<p>If you are interested in how to distribute the data and manage that in a reliable manner, you might want to read up on the <a href="https://raft.github.io/">Raft algorithm</a> and
there is a great example <a href="https://github.com/rqlite/rqlite">in the rqlite project</a>, which enable you to use Sqlite in a distributed manner.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_intercepting_writes_to_the_wal">Intercepting writes to the WAL</h3>
<div class="paragraph">
<p>In <code>db_options_t</code> we have the <code>wal_write_callback</code> field, this is a function pointer whose signature you can see in <a href="#wal_write_callback_t"><code>gavran/db.h</code> - The write callback signature</a>.</p>
</div>
<div id="wal_write_callback_t" class="listingblock">
<div class="title"><code>gavran/db.h</code> - The write callback signature</div>
<div class="content">
<pre class="highlight"><code>typedef void (*wal_write_callback_t)(
    void *state, uint64_t tx_id, span_t *wal_record);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The idea is that whenever we write to the WAL, we&#8217;ll call this callback function and allow the caller to copy the WAL transaction record. By defining the signature
in this way, we have enforced several design decisions. The <code>wal_write_callback</code> has no way to convey failure. That is intentional, we are going to call this callback
<em>after</em> we already wrote transaction to the WAL. In such a case, the transaction has been <em>committed</em>, there is no way to roll it back.</p>
</div>
<div class="paragraph">
<p>The callback should be written in such a way that is is robust to failure. If we are working with a distributed system, maybe write it to the a temporary file if we
can&#8217;t connect to the other system. If we are working on a backup and we run out of space on the disk, we may decide to notify the admin so they can clean the disk and
create a snapshot. The key here is that this isn&#8217;t something that <em>Gavran</em> is interested about. The callback is a courtesy, we&#8217;ll let the callback know that a WAL
write happened, but any errors should be handled there.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Strategies for handling callback errors</div>
<div class="paragraph">
<p>There are ways that we could have made the callback author&#8217;s life easier. If we had a way to report errors, for example, that would be great. The problem is what
are we supposed to <em>do</em> about it. Consider the case where we are using the callback to generate a backup log. We can invoke the callback before the actual write
to disk and abort the transaction on error. That sounds just great, right?</p>
</div>
<div class="paragraph">
<p>But what happens if <em>after</em> we wrote to the backup, we&#8217;ll try to write to the disk and <em>fail</em>? In this case, we have inconsistent state. There are transactions in the
backup that aren&#8217;t on data file, they have been rolled back.</p>
</div>
<div class="paragraph">
<p>Conversely, if we invoke the callback <em>after</em> the write, we have to deal with the fact that the callback failed, but the WAL has a valid transaction. We could try
overwriting it with invalid data (effectively nulling the previous write), though. That <em>sounds</em> okay, but it won&#8217;t work. What happens if we crashed immediately after
successfully writing to the file? The callback didn&#8217;t run, it didn&#8217;t have a chance. And we&#8217;ll recover the transaction from the log as usual.</p>
</div>
<div class="paragraph">
<p>As you can see, this is a tough issue and I&#8217;m quite happy to declare what is the responsibility of Gavran and what should be handled elsewhere.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In <a href="#wal_append_13"><code>wal.c</code> - Invoking the user&#8217;s callback after writing to disk</a> you can see the changes we made to the <code>wal_append()</code> function to invoke the callback in the right place.</p>
</div>
<div id="wal_append_13" class="listingblock">
<div class="title"><code>wal.c</code> - Invoking the user&#8217;s callback after writing to disk</div>
<div class="content">
<pre class="highlight"><code>result_t wal_append(txn_state_t *tx) {
  wal_txn_t *txn_buffer   = 0;
  size_t skip_free_buffer = 0;
  try_defer(free, txn_buffer, skip_free_buffer);

  // <b class="conum">(1)</b>
  if (tx-&gt;flags &amp; txn_flags_apply_log) {
    skip_free_buffer = 1;
    txn_buffer       = tx-&gt;shipped_wal_record;
  } else {
    ensure(wal_prepare_txn_buffer(tx, &amp;txn_buffer));
    const size_t size = crypto_generichash_BYTES;
    ensure(!crypto_generichash(txn_buffer-&gt;hash_blake2b, size,
               (uint8_t *)txn_buffer + size,
               txn_buffer-&gt;page_aligned_tx_size - size, 0, 0),
        msg("Unable to compute hash for transaction"),
        with(txn_buffer-&gt;tx_id, "%lu"));
  }

  wal_state_t *wal = &amp;tx-&gt;db-&gt;wal_state;
  wal_file_state_t *cur_file =
      &amp;wal-&gt;files[wal-&gt;current_append_file_index];
  ensure(wal_increase_file_size_if_needed(
      cur_file, txn_buffer-&gt;page_aligned_tx_size));
  ensure(pal_write_file(cur_file-&gt;handle, cur_file-&gt;last_write_pos,
      (char *)txn_buffer, txn_buffer-&gt;page_aligned_tx_size));
  cur_file-&gt;last_write_pos += txn_buffer-&gt;page_aligned_tx_size;
  cur_file-&gt;last_tx_id = tx-&gt;tx_id;
  // <b class="conum">(2)</b>
  if (tx-&gt;db-&gt;options.wal_write_callback) {
    span_t wal_record = {.address = txn_buffer,
        .size                     = txn_buffer-&gt;page_aligned_tx_size};
    tx-&gt;db-&gt;options.wal_write_callback(
        tx-&gt;db-&gt;options.wal_write_callback_state, txn_buffer-&gt;tx_id,
        &amp;wal_record);
  }
  return success();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Check if we <em>received</em> a log shipping record, if not, prepare the transaction buffer normally.</p>
</li>
<li>
<p>Invoking the callback after the <code>pal_write_file()</code> call.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>I&#8217;m not going to implement it at this stage, but there are other options for handling failures in the WAL. We can allow the user to tell us when it is okay to reset the WAL.
If we are trying to send Transaction No. 17 to another server but it is currently unavailable, we can make sure that <code>wal_will_checkpoint()</code> will return false. Then when we
resume connectivity to the other side, we&#8217;ll be able to scan through the WAL file and send any past transactions that were dropped. That requires more machinery and I&#8217;m writing
this chapter mostly to show how we can use the WAL to do more than just recover the data. I just wanted to point out that there <em>are</em> options to handle this gracefully.</p>
</div>
</div>
<div class="sect2">
<h3 id="_applying_log_records_on_live_database">Applying log records on live database</h3>
<div class="paragraph">
<p>We have seen how we can recover transactions previously, on database startup. The process of applying the WAL records from one instance to another is pretty much the same. The
major difference is that we need to handle concurrent transactions while this is happening, while the recovery process can assume that nothing else is running. By concurrent
transactions, I mean that we have read transactions running. By the very nature of log shipping, only the instance that <em>ships</em> the logs can run a write transaction. All other
instances are strictly observers.</p>
</div>
<div class="paragraph">
<p>There isn&#8217;t really a requirement that only a single instance will do all the writes, but there <em>is</em> a requirement that the writes will create a single cohesive log. In other
words, instance <code>A</code> writing tx 7 and then instance <code>B</code> writing tx 8 on top of tx 7&#8217;s changes is fine. in practice, distributed coordination is <em>hard</em> and it is better to slap:
"only a single primary, ever!" sign on our options.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s consider what we need to do on the other side of a the log shipping process. We are going to accept <code>tx_id</code> and the <code>wal_record</code>. We need to go from these into an
applied transaction. How can we do that? In <code>wal_recover_tx()</code>, we are doing pretty much the same thing, but we assume that we are alone and that the our WAL is stable. In the
case of accepting a log shipping record from the outside world, there are a few notable differences:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We have to deal with concurrent read transactions and not interfere with them.</p>
</li>
<li>
<p>We have to write the new record into <em>our</em> WAL. We can&#8217;t just write it to the data file, we need to persist the changes in such a way that failure of the database will not
lose any data that we confirmed receipt of.</p>
</li>
<li>
<p>The database size may have increased during the transaction.</p>
</li>
<li>
<p>During the application of the <code>wal_record</code>, the state of the database is not consistent.</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Applying a remote transaction and inconsistent state</div>
<div class="paragraph">
<p>During the application of the <code>wal_record</code>, the state of the database is not consistent. This statement requires further explanation, I think. Consider a transaction that modify a
value on Page 3. When the transaction is committed, we also update the page&#8217;s
hash to reflect the updated value. In this case, that means that we updated Page 0 as well. We ship this transaction to the other instance and apply it. When we apply Page 0,
we instantly ensure that access to Page 3 will be invalid. The hash no longer match, after all. And vice versa, if we update Page 3 and then try to access it, the hash on
Page 0 will reflect the <em>old</em> value, meaning that we are again going to get an error.</p>
</div>
<div class="paragraph">
<p>The situation is actually worse when we consider how to deal with encrypted databases,
but the core of the problem remains the same. We must apply the changes to the system as a whole before we can access the data. Once we applied all the changes, the state of
the system is consistent, but during the process of writing the remote transaction, we have a database in an inconsistent state. Good thing that Gavran implements snapshot
isolation, so no one else can observe this until we finish doing all the work and commit the transaction.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Ideally, the log shipping should be able to operate blindingly, without really caring what data is changed. In order to help that, we&#8217;ll set the <code>total_number_of_pages_in_database</code>
field in <code>wal_txn_t</code> to the size of the database. The <code>wal_txn_t</code> isn&#8217;t encrypted, and the size of the database isn&#8217;t a secret, so there is no harm in doing so. It also
<em>drastically</em> simplify handling of log shipping with encrypted databases.</p>
</div>
<div class="paragraph">
<p>The core behavior for log shipping is implemented in <code>wal_apply_wal_record()</code>, which you can see in <a href="#wal_apply_wal_record"><code>wal.c</code> - Apply a WAL record to a live database</a>.</p>
</div>
<div id="wal_apply_wal_record" class="listingblock">
<div class="title"><code>wal.c</code> - Apply a WAL record to a live database</div>
<div class="content">
<pre class="highlight"><code>result_t wal_apply_wal_record(db_t *db, reusable_buffer_t *tmp_buffer,
    uint64_t tx_id, span_t *wal_record) {
  ensure(db-&gt;state-&gt;options.flags &amp; db_flags_log_shipping_target,
      msg("db wasn't set with db_flags_apply_log flag"));
  ensure(((intptr_t)wal_record-&gt;address &amp; 4095) == 0,
      msg("wal_record must be aligned on 4KB boundary, but wasn't"),
      with(wal_record-&gt;address, "%p"));
  // <b class="conum">(1)</b>
  txn_t write_tx;
  ensure(txn_create(db, TX_WRITE | TX_APPLY_LOG, &amp;write_tx));
  defer(txn_close, write_tx);
  write_tx.state-&gt;shipped_wal_record = wal_record-&gt;address;

  // <b class="conum">(2)</b>
  wal_txn_t *wal_tx;
  ensure(wal_validate_transaction(tmp_buffer, wal_record-&gt;address,
      wal_record-&gt;address + wal_record-&gt;size, &amp;wal_tx));
  // <b class="conum">(3)</b>
  ensure(wal_tx, msg("Unable to validate WAL transaction"));
  ensure(wal_tx-&gt;tx_id == write_tx.state-&gt;tx_id &amp;&amp;
             tx_id == wal_tx-&gt;tx_id,
      msg("Cannot apply a transaction out of order"),
      with(tx_id, "%lu"), with(wal_tx-&gt;tx_id, "%lu"),
      with(write_tx.state-&gt;tx_id, "%lu"));

  // <b class="conum">(4)</b>
  if (wal_tx-&gt;total_number_of_pages_in_database &gt;
      write_tx.state-&gt;number_of_pages) {
    ensure(db_increase_file_size(&amp;write_tx,
        wal_tx-&gt;total_number_of_pages_in_database * PAGE_SIZE));
  }
  // <b class="conum">(5)</b>
  void *input =
      (void *)wal_tx + sizeof(wal_txn_t) +
      sizeof(wal_txn_page_t) * wal_tx-&gt;number_of_modified_pages;
  ensure(wal_apply_log_write_pages(
      wal_tx, &amp;write_tx, input, wal_record-&gt;address));
  ensure(txn_commit(&amp;write_tx));
  return success();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Open a new write transaction, marking it as <code>TX_APPLY_LOG</code> so we&#8217;ll know that we need to treat it differently. We also pass the WAL record to the transaction
so we can avoid work during the transaction commit.</p>
</li>
<li>
<p>Validate the transaction buffer, along the way making sure to decompress the transaction data if the transaction is compressed.</p>
</li>
<li>
<p>Verify that the transaction passed validation and it is in the same order as expected. Each write transaction will increase the <code>tx_id</code>, and we must match it to the
shipped record to pass validation. This help ensure that we aren&#8217;t going to run into conflicting writes.</p>
</li>
<li>
<p>Make sure that the file size match the file size expected by the transaction we are replaying.</p>
</li>
<li>
<p>Apply all the pages from the transaction and commit.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A lot is going on in <a href="#wal_apply_wal_record"><code>wal.c</code> - Apply a WAL record to a live database</a>. We start by creating a transaction with a state that we weren&#8217;t familiar with so far, <code>TX_APPLY_LOG</code>. This indicates to Gavran
that this transaction is going to process transaction that came from the outside world. We are also setting the  <code>state-&gt;shipped_wal_record</code> field which gives the transaction
access to the <code>wal_record</code> for the transaction.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">Reusing the buffer</div>
<div class="paragraph">
<p>In <code>wal_apply_wal_record()</code> we have the <code>tmp_buffer</code> value.
This is meant to be kept <em>across</em> invocations of <code>wal_apply_wal_record()</code>, to avoid allocating and releasing the memory on each processed record</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We are able to use this <code>wal_record</code> to optimize the commit process of the transaction. Instead of finalizing the transaction ourselves (encrypting or hashing the pages,
compressing the data, computing the transaction hash, etc) we can just write the shipped record buffer directly to our own WAL.</p>
</div>
<div class="paragraph">
<p>With log shipping, we need to take additional precautions. We validate the transaction as if we read it from a file using <code>wal_validate_transaction()</code>. It is especially important to
validate the <em>order</em> of transactions. We make sure that the incoming shipped record is a match to the transaction id we expect. In case of divergence, we&#8217;ll be able to error
immediately, instead of losing data or corrupting our internal structure.</p>
</div>
<div class="paragraph">
<p>A key issue that we have to deal with is that the transaction may grow the data file. We handle with the <code>total_number_of_pages_in_database</code> and increasing the file size before we
process the rest of the transaction. The actual processing of the pages in the transaction is done using and in <code>wal_apply_log_write_pages()</code> shown in <a href="#wal_apply_log_write_pages"><code>wal.c</code> - Apply a shipped transaction pages to our own data file</a>.</p>
</div>
<div id="wal_apply_log_write_pages" class="listingblock">
<div class="title"><code>wal.c</code> - Apply a shipped transaction pages to our own data file</div>
<div class="content">
<pre class="highlight"><code>static result_t wal_apply_log_write_pages(
    wal_txn_t *wal_tx, txn_t *write_tx, void *input, void *src) {
  for (size_t i = 0; i &lt; wal_tx-&gt;number_of_modified_pages; i++) {
    wal_txn_page_t *cur = &amp;wal_tx-&gt;pages[i];
    size_t end_offset   = i + 1 &lt; wal_tx-&gt;number_of_modified_pages
                            ? wal_tx-&gt;pages[i + 1].offset
                            : wal_tx-&gt;tx_size;
    page_t page = {.page_num = cur-&gt;page_num,
        .number_of_pages     = cur-&gt;number_of_pages};
    ensure(txn_raw_modify_page(write_tx, &amp;page));
    if (cur-&gt;flags == wal_txn_page_flags_diff) {
      input =
          wal_apply_diff(input, (void *)wal_tx + end_offset, &amp;page);
    } else {
      memcpy(page.address, src + cur-&gt;offset,
          cur-&gt;number_of_pages * PAGE_SIZE);
      input += cur-&gt;number_of_pages * PAGE_SIZE;
    }
  }
  return success();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In <a href="#wal_apply_log_write_pages"><code>wal.c</code> - Apply a shipped transaction pages to our own data file</a> we are iterating over the pages in the transaction and applying them to the data file. This is very similar to how we deal with recover in <code>wal_recover_tx()</code>.
There is a <em>major</em> change here, however, we are not writing directly to the file. Instead, we are effectively re-running the transaction. Why are we doing this?
We use the transaction API so concurrent transactions that are now running can still operate. In other words, as far as the rest of the system is concerned, the shipped transactions
are just normal transactions that behave in the same manner.
Shipped transactions use <code>modified_pages</code>, follow the same snapshot rules and write to the WAL to make sure that we maintain the ACID properties of Gavran.</p>
</div>
<div class="paragraph">
<p>There are a few things that we had to modify to make sure that everything works, though. If you&#8217;ll look at <a href="#wal_apply_log_write_pages"><code>wal.c</code> - Apply a shipped transaction pages to our own data file</a> you can see that we use <code>txn_raw_modify_page()</code>,
but that is <em>problematic</em> for us, as we saw before. Page validation and decryption will now work properly while we are writing pages from a remote transaction. The solution to that is
to detect such transactions and handle it.</p>
</div>
<div class="paragraph">
<p><a href="#txn_raw_get_page_13"><code>txn.c</code> - Avoid validation and decryption for transaction that apply remote transactions</a> shows the changes made to <code>txn_raw_get_page()</code> to support applying remote transactions. We check the transaction&#8217;s flag and if it is a transaction that is applying
a remote transaction, we&#8217;ll skip validation and decryption.</p>
</div>
<div id="txn_raw_get_page_13" class="listingblock">
<div class="title"><code>txn.c</code> - Avoid validation and decryption for transaction that apply remote transactions</div>
<div class="content">
<pre class="highlight"><code>result_t txn_raw_get_page(txn_t *tx, page_t *page) {
  errors_assert_empty();
  page-&gt;address = 0;
  if (!(tx-&gt;state-&gt;flags &amp; TX_COMMITED) &amp;&amp;
      pagesmap_lookup(tx-&gt;state-&gt;modified_pages, page))
    return success();
  if (pagesmap_lookup(tx-&gt;working_set, page)) return success();
  txn_state_t *prev = tx-&gt;state;
  while (prev) {
    if (pagesmap_lookup(prev-&gt;modified_pages, page)) break;
    prev = prev-&gt;prev_tx;
  }

  if (!page-&gt;address) {
    if (!page-&gt;number_of_pages) page-&gt;number_of_pages = 1;
    ensure(pages_get(tx, page));
  }

  // <b class="conum">(1)</b>
  if (!(tx-&gt;state-&gt;flags &amp; txn_flags_apply_log)) {
    if (tx-&gt;state-&gt;flags &amp; db_flags_encrypted) {
      ensure(txn_decrypt_page(tx, page));
    } else {
      ensure(txn_ensure_page_is_valid(tx, page));
    }
  }

  return success();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We use <code>txn_raw_modify_page()</code> in <a href="#wal_apply_log_write_pages"><code>wal.c</code> - Apply a shipped transaction pages to our own data file</a>, but the changes are made in <code>txn_raw_get_page()</code>. That is because <code>txn_raw_modify_page()</code> implement reading via <code>txn_raw_get_page()</code>.
It is also important to note that this means that the transaction in <a href="#wal_apply_log_write_pages"><code>wal.c</code> - Apply a shipped transaction pages to our own data file</a> is going to get <em>encrypted</em> pages. The process of applying a remote transaction is totally blind to
what is going on the file.</p>
</div>
<div class="paragraph">
<p>In <a href="#tests13"><code>test.c</code> - Testing log shipping</a> you&#8217;ll see a test <code>"log shipping with encryption, destination without key"</code> that show how we can use log shipping from an encrypted database to another instance that <em>doesn&#8217;t have the
encryption key</em>. Of course, if we want to handle reads, we have to provide the key at a later point in time. But no key is required for the actual log shipping.</p>
</div>
<div class="paragraph">
<p>Transaction commits when applying a remote transaction is also different as you can see in <a href="#txn_commit_13"><code>txn.c</code> - Changes in <code>txn_commit()</code> to support committing remote transactions</a>.</p>
</div>
<div id="txn_commit_13" class="listingblock">
<div class="title"><code>txn.c</code> - Changes in <code>txn_commit()</code> to support committing remote transactions</div>
<div class="content">
<pre class="highlight"><code>result_t txn_commit(txn_t *tx) {
  errors_assert_empty();
  if (!tx-&gt;state-&gt;modified_pages-&gt;count) return success();

  // <b class="conum">(1)</b>
  if (!(tx-&gt;state-&gt;flags &amp; txn_flags_apply_log)) {
    page_metadata_t *header;
    ensure(txn_modify_metadata(tx, 0, &amp;header));
    header-&gt;file_header.last_tx_id = tx-&gt;state-&gt;tx_id;
    ensure(txn_finalize_modified_pages(tx));
  }

  ensure(wal_append(tx-&gt;state));
    // rest of the function is unchanged
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>New code, we only need to finalize a transaction is this <em>our</em> transaction. A remote transaction was already finalized and we applied those changes.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In <a href="#txn_commit_13"><code>txn.c</code> - Changes in <code>txn_commit()</code> to support committing remote transactions</a> you can see that if we are processing a remote transaction, we skip some important steps in the commit process. This is because these steps were already taken, on the <em>other</em> side.
There is no point in doing these again. Indeed, we cannot if we want to operate blindly on the data. We also have a similar change to <code>wal_append()</code> shown in <a href="#wal_append_13"><code>wal.c</code> - Invoking the user&#8217;s callback after writing to disk</a>.</p>
</div>
<div class="paragraph">
<p>The final important change we have is when creating a new database, <a href="#db_init_13"><code>db.c</code> - There is no use for <code>db_init()</code> when we are the destination for log shipping</a> shows the changes to <code>db_init()</code>.</p>
</div>
<div id="db_init_13" class="listingblock">
<div class="title"><code>db.c</code> - There is no use for <code>db_init()</code> when we are the destination for log shipping</div>
<div class="content">
<pre class="highlight"><code>implementation_detail result_t db_init(db_t *db) {
  // <b class="conum">(1)</b>
  if ((db-&gt;state-&gt;options.flags &amp; db_flags_log_shipping_target) ==
      db_flags_log_shipping_target)
    return success();
  bool is_new;
  ensure(db_is_new_file(db, &amp;is_new));
  if (is_new) {
    ensure(db_init_file_structure(db));
  }
  ensure(db_validate_file_on_startup(db));
  return success();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>New code, if we are the target of log shipping, we should do nothing. The database initialization happens on the <em>other</em> side.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The reason for the changes in <a href="#db_init_13"><code>db.c</code> - There is no use for <code>db_init()</code> when we are the destination for log shipping</a> may not be obvious. One of the <em>important</em> rules of log shipping is that there is a single history of transactions. You cannot apply a transaction
out of order or with missing information. You have to always have the same sequence of transactions. The problem is that <code>db_init()</code> will write a transaction to the file, but that would mean
that transaction 1 was done on the destination. When transaction 1 comes from the source, it cannot be applied, because the sequence of transaction don&#8217;t match. There is also the issue of what
would happen if we initialized the databases with different configuration, etc.</p>
</div>
<div class="paragraph">
<p>This concludes the details we need to concern ourselves with for log shipping. For such a feature, the amount of code required is actually pretty minimal, even if we are ignoring the "how" of
sending the WAL records between instances.</p>
</div>
</div>
<div class="sect2">
<h3 id="_additional_considerations_for_log_shipping">Additional considerations for log shipping</h3>
<div class="paragraph">
<p>We covered the coding parts of log shipping, but there are other things we need to take into account. The way I implemented log shipping in Gavran, you must start the database in log shipping
mode if you want it to be at target for log shipping. That is done by specifying <code>db_flags_log_shipping_target</code> on the database&#8217;s options <code>flags</code> field. When this value is set, there are some
changes to the way Gavran behaves:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You cannot use write transactions, the only allowed changes are via <code>wal_apply_wal_record()</code>.</p>
</li>
<li>
<p>You cannot call <code>wal_apply_wal_record()</code> on a database that isn&#8217;t marked with <code>db_flags_log_shipping_target</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These are restrictions that I added, to avoid users causing themselves injuries. If there is a need to switch from log shipping mode to normal mode (to allow local writes), you can restart
the database without the <code>db_flags_log_shipping_target</code> to allow it. Allowing users to turn log shipping target on and off easily is something that is already possible, but I worry that it
would lead to making changes in multiple locations and preventing the log shipping process from succeeding.</p>
</div>
<div class="paragraph">
<p>As I mentioned, you <em>can</em> use an instance as the destination of an encrypted database without supplying the encryption key. That might be a good idea if you want to keep a copy of the
database on the side. If you need to actually read from the database, you&#8217;ll need to supply the key of course.</p>
</div>
<div class="paragraph">
<p>Finally, while I talked a lot about log shipping, which implies that we&#8217;ll apply the logs immediately, that doesn&#8217;t have to be the case. One use case for log shipping is to implement incremental
backup strategy.</p>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_incremental_backup_using_log_shipping">Implementing incremental backup using log shipping</h3>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
<div class="title">Treat the code in this section as a draft, not a ready made solution</div>
<div class="paragraph">
<p>I&#8217;m going to present an incremental backup solution in this section, but I want to emphasis that this is more a concept that production ready code. There are a lot of things that I&#8217;m ignoring
here that you&#8217;ll probably have to deal with if you wanted to create a proper system. The point of the code is to show the <em>idea</em> and how you can take the log shipping feature and utilize it in
all sorts of interesting ways.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The idea with incremental backups using log shipping is simple. We&#8217;ll get called whenever a transaction is committed. We&#8217;ll take those transactions and write them to a file and then we can
use that to recover. Let&#8217;s see how that work in <a href="#incremental_backup"><code>test.c</code> - Building the incremental backup file</a>.</p>
</div>
<div id="incremental_backup" class="listingblock">
<div class="title"><code>test.c</code> - Building the incremental backup file</div>
<div class="content">
<pre class="highlight"><code>static void incremental_backup(
    void* state, uint64_t tx_id, span_t* wal_record) {
  FILE* dst  = state;
  time_t now = time(0);
  fwrite(&amp;now, sizeof(time_t), 1, dst);
  fwrite(&amp;tx_id, sizeof(uint64_t), 1, dst);
  uint64_t size = wal_record-&gt;size;
  fwrite(&amp;size, sizeof(uint64_t), 1, dst);
  fwrite(wal_record-&gt;address, 1, wal_record-&gt;size, dst);
}

        db_t src;
        FILE* backup = fopen("/tmp/db/try.backup", "wb");
        defer(fclose, backup);
        db_options_t src_options = {.minimum_size = 4 * 1024 * 1024,
            .wal_write_callback       = incremental_backup,
            .wal_write_callback_state = backup};
        assert(db_create("/tmp/db/try", &amp;src_options, &amp;src));
        defer(db_close, src);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see in <a href="#incremental_backup"><code>test.c</code> - Building the incremental backup file</a> that we define a <code>FILE* backup</code> that is passed as the state for the <code>incremental_backup()</code> function. This is called whenever we commit a transaction and
will write the transaction data to the <code>backup</code> file. We also write some additional metadata, the time of the transaction, the transaction id and its size. This allows us to do some nice
tricks. For example, restore up to a particular point in time.</p>
</div>
<div class="paragraph">
<p>You can see the restore side of things in <a href="#apply_backups"><code>test.c</code> - Applying an incremental backup to a database</a>, where we read from the file.</p>
</div>
<div id="apply_backups" class="listingblock">
<div class="title"><code>test.c</code> - Applying an incremental backup to a database</div>
<div class="content">
<pre class="highlight"><code>static result_t apply_backups(
    const char* db_file, const char* backup_file, time_t until) {
  db_t db;
  db_options_t options = {.minimum_size = 4 * 1024 * 1024,
      .flags = db_flags_log_shipping_target};
  ensure(db_create(db_file, &amp;options, &amp;db));
  defer(db_close, db);
  file_handle_t* f;
  ensure(
      pal_create_file(backup_file, &amp;f, pal_file_creation_flags_none));
  defer(pal_close_file, f);
  span_t span = {.size = f-&gt;size};
  ensure(pal_mmap(f, 0, &amp;span));
  defer(pal_unmap, span);
  void* start                  = span.address;
  void* end                    = span.address + span.size;
  reusable_buffer_t tmp_buffer = {0};
  defer(free, tmp_buffer.address);
  while (start &lt; end) {
    time_t time = *(time_t*)start;
    if (time &gt; until) break;
    start += sizeof(time_t);
    uint64_t tx_id = *(uint64_t*)start;
    start += sizeof(uint64_t);
    uint64_t tx_size = *(uint64_t*)start;
    start += sizeof(uint64_t);
    span_t tx = {.size = (size_t)tx_size};
    ensure(mem_alloc_page_aligned(&amp;tx.address, tx.size));
    defer(free, tx.address);
    memcpy(tx.address, start, tx.size);
    ensure(wal_apply_wal_record(&amp;db, &amp;tmp_buffer, tx_id, &amp;tx));
    start += tx_size;
  }
  return success();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code in <a href="#apply_backups"><code>test.c</code> - Applying an incremental backup to a database</a> is straightforward, we read the time of the transaction and if it isn&#8217;t too late, we apply it using <code>wal_apply_wal_record()</code>. You can see these being used in the
<code>"can use log shipping for backups"</code> test.</p>
</div>
<div class="paragraph">
<p>What is missing from this backup implementation? From the top of my head we aren&#8217;t handling restarts of the database. Right now it will not work properly if you restart the database. We are also
not ensuring that the writes hit the disk, if there is a failure, we will have a committed transaction but no backup. There are probably many other details that I&#8217;m missing, those were just to
prove that this is just the start of this feature.</p>
</div>
<div class="paragraph">
<p>Note that what we <em>do</em> have, however, is quite impressive. We can do full &amp; incremental backups. If we take the data file, we can apply the incremental backup on top of that. Backups are usually
compressed, but in this case, we don&#8217;t need to. The WAL records are either already compressed or encrypted (in which case they cannot be compressed).</p>
</div>
<div class="paragraph">
<p>And with that, we are closing the chapter and this part of the book. We have implemented a <em>lot</em> of functionality at the lowest tiers of the storage engine. Now it is time to start building
data structures and actually <em>using</em> Gavran.</p>
</div>
</div>
<div class="sect2">
<h3 id="_unit_tests">Unit Tests</h3>
<div class="paragraph">
<p>The tests we have here verify that log shipping work by running everything in a single process and shared memory ownership. Extending the tests a bit, you can use something like
<a href="https://zeromq.org/">ZeroMQ</a> to handle the actual distribution of the data. Just remember to ensure that there are no missed or out of order transactions.</p>
</div>
<div id="tests13" class="listingblock">
<div class="title"><code>test.c</code> - Testing log shipping</div>
<div class="content">
<pre class="highlight"><code>typedef struct db_and_error_state {
  db_t* db;
  bool has_errors;
} db_and_error_state_t;

static void ship_wal_logs(
    void* state, uint64_t tx_id, span_t* wal_record) {
  db_and_error_state_t* db_n_err = state;
  reusable_buffer_t buffer       = {0};
  defer(free, buffer.address);
  if (flopped(wal_apply_wal_record(
          db_n_err-&gt;db, &amp;buffer, tx_id, wal_record))) {
    db_n_err-&gt;has_errors = true;
  }
}

static void incremental_backup(
    void* state, uint64_t tx_id, span_t* wal_record) {
  FILE* dst  = state;
  time_t now = time(0);
  fwrite(&amp;now, sizeof(time_t), 1, dst);
  fwrite(&amp;tx_id, sizeof(uint64_t), 1, dst);
  uint64_t size = wal_record-&gt;size;
  fwrite(&amp;size, sizeof(uint64_t), 1, dst);
  fwrite(wal_record-&gt;address, 1, wal_record-&gt;size, dst);
}

static result_t apply_backups(
    const char* db_file, const char* backup_file, time_t until) {
  db_t db;
  db_options_t options = {.minimum_size = 4 * 1024 * 1024,
      .flags = db_flags_log_shipping_target};
  ensure(db_create(db_file, &amp;options, &amp;db));
  defer(db_close, db);
  file_handle_t* f;
  ensure(
      pal_create_file(backup_file, &amp;f, pal_file_creation_flags_none));
  defer(pal_close_file, f);
  span_t span = {.size = f-&gt;size};
  ensure(pal_mmap(f, 0, &amp;span));
  defer(pal_unmap, span);
  void* start                  = span.address;
  void* end                    = span.address + span.size;
  reusable_buffer_t tmp_buffer = {0};
  defer(free, tmp_buffer.address);
  while (start &lt; end) {
    time_t time = *(time_t*)start;
    if (time &gt; until) break;
    start += sizeof(time_t);
    uint64_t tx_id = *(uint64_t*)start;
    start += sizeof(uint64_t);
    uint64_t tx_size = *(uint64_t*)start;
    start += sizeof(uint64_t);
    span_t tx = {.size = (size_t)tx_size};
    ensure(mem_alloc_page_aligned(&amp;tx.address, tx.size));
    defer(free, tx.address);
    memcpy(tx.address, start, tx.size);
    ensure(wal_apply_wal_record(&amp;db, &amp;tmp_buffer, tx_id, &amp;tx));
    start += tx_size;
  }
  return success();
}

static inline void defer_fclose(cancel_defer_t* cd) {
  if (cd-&gt;cancelled &amp;&amp; *cd-&gt;cancelled) return;
  fclose(*(void**)cd-&gt;target);
}

describe(log_shipping) {
  before_each() {
    errors_clear();
    system("mkdir -p /tmp/db");
    system("rm -f /tmp/db/*");
  }

  it("can use log shipping between instances") {
    db_t src, dst;

    db_options_t dst_options = {.minimum_size = 4 * 1024 * 1024,
        .flags = db_flags_log_shipping_target};
    assert(db_create("/tmp/db/try-dst", &amp;dst_options, &amp;dst));
    defer(db_close, dst);

    db_and_error_state_t state = {.db = &amp;dst};
    db_options_t src_options   = {.minimum_size = 4 * 1024 * 1024,
        .wal_write_callback                   = ship_wal_logs,
        .wal_write_callback_state             = &amp;state};
    assert(db_create("/tmp/db/try-src", &amp;src_options, &amp;src));
    defer(db_close, src);

    uint64_t page;
    {
      txn_t w;
      assert(txn_create(&amp;src, TX_WRITE, &amp;w));
      defer(txn_close, w);
      page_t p = {.number_of_pages = 1};
      assert(txn_allocate_page(&amp;w, &amp;p, 0));
      page                                 = p.page_num;
      p.metadata-&gt;overflow.page_flags      = page_flags_overflow;
      p.metadata-&gt;overflow.number_of_pages = 1;
      strcpy(p.address, "Hello Remotely");
      assert(txn_commit(&amp;w));
    }
    {
      txn_t r;
      assert(txn_create(&amp;dst, TX_READ, &amp;r));
      defer(txn_close, r);
      page_t p = {.page_num = page};
      assert(txn_get_page(&amp;r, &amp;p));
      assert(strcmp("Hello Remotely", p.address) == 0);
    }
  }

  it("can use log shipping for backups") {
    {
      uint64_t page;
      {
        db_t src;
        FILE* backup = fopen("/tmp/db/try.backup", "wb");
        defer(fclose, backup);
        db_options_t src_options = {.minimum_size = 4 * 1024 * 1024,
            .wal_write_callback       = incremental_backup,
            .wal_write_callback_state = backup};
        assert(db_create("/tmp/db/try", &amp;src_options, &amp;src));
        defer(db_close, src);

        {
          txn_t w;
          assert(txn_create(&amp;src, TX_WRITE, &amp;w));
          defer(txn_close, w);
          page_t p = {.number_of_pages = 1};
          assert(txn_allocate_page(&amp;w, &amp;p, 0));
          page                                 = p.page_num;
          p.metadata-&gt;overflow.page_flags      = page_flags_overflow;
          p.metadata-&gt;overflow.number_of_pages = 1;
          strcpy(p.address, "Hello Remotely");
          assert(txn_commit(&amp;w));
        }
      }

      assert(apply_backups(
          "/tmp/db/restored", "/tmp/db/try.backup", LONG_MAX));
      {
        db_t db;
        db_options_t options = {.minimum_size = 4 * 1024 * 1024};
        assert(db_create("/tmp/db/restored", &amp;options, &amp;db));
        defer(db_close, db);

        txn_t r;
        assert(txn_create(&amp;db, TX_READ, &amp;r));
        defer(txn_close, r);
        page_t p = {.page_num = page};
        assert(txn_get_page(&amp;r, &amp;p));
        assert(strcmp("Hello Remotely", p.address) == 0);
      }
    }
  }

  it("can use log shipping between instances with 32 bits") {
    db_t src, dst;

    db_options_t dst_options = {.minimum_size = 4 * 1024 * 1024,
        .flags =
            db_flags_avoid_mmap_io | db_flags_log_shipping_target};
    assert(db_create("/tmp/db/try-dst", &amp;dst_options, &amp;dst));
    defer(db_close, dst);

    db_and_error_state_t state = {.db = &amp;dst};
    db_options_t src_options   = {.minimum_size = 4 * 1024 * 1024,
        .wal_write_callback                   = ship_wal_logs,
        .flags                    = db_flags_avoid_mmap_io,
        .wal_write_callback_state = &amp;state};
    assert(db_create("/tmp/db/try-src", &amp;src_options, &amp;src));
    defer(db_close, src);

    uint64_t page;
    {
      txn_t w;
      assert(txn_create(&amp;src, TX_WRITE, &amp;w));
      defer(txn_close, w);
      page_t p = {.number_of_pages = 1};
      assert(txn_allocate_page(&amp;w, &amp;p, 0));
      page                                 = p.page_num;
      p.metadata-&gt;overflow.page_flags      = page_flags_overflow;
      p.metadata-&gt;overflow.number_of_pages = 1;
      strcpy(p.address, "Hello Remotely");
      assert(txn_commit(&amp;w));
    }
    {
      txn_t r;
      assert(txn_create(&amp;dst, TX_READ, &amp;r));
      defer(txn_close, r);
      page_t p = {.page_num = page};
      assert(txn_get_page(&amp;r, &amp;p));
      assert(strcmp("Hello Remotely", p.address) == 0);
    }
  }

  it("can use log shipping between instances with encryption") {
    db_t src, dst;

    char key[32];
    randombytes_buf(key, 32);

    db_options_t dst_options = {.minimum_size = 4 * 1024 * 1024,
        .flags = db_flags_log_shipping_target};
    memcpy(dst_options.encryption_key, key, 32);
    assert(db_create("/tmp/db/try-dst", &amp;dst_options, &amp;dst));
    defer(db_close, dst);

    db_and_error_state_t state = {.db = &amp;dst};
    db_options_t src_options   = {.minimum_size = 4 * 1024 * 1024,
        .wal_write_callback                   = ship_wal_logs,
        .wal_write_callback_state             = &amp;state};
    memcpy(src_options.encryption_key, key, 32);
    assert(db_create("/tmp/db/try-src", &amp;src_options, &amp;src));
    defer(db_close, src);

    uint64_t page;
    {
      txn_t w;
      assert(txn_create(&amp;src, TX_WRITE, &amp;w));
      defer(txn_close, w);
      page_t p = {.number_of_pages = 1};
      assert(txn_allocate_page(&amp;w, &amp;p, 0));
      page                                 = p.page_num;
      p.metadata-&gt;overflow.page_flags      = page_flags_overflow;
      p.metadata-&gt;overflow.number_of_pages = 1;
      strcpy(p.address, "Hello Remotely");
      assert(txn_commit(&amp;w));
    }
    {
      txn_t r;
      assert(txn_create(&amp;dst, TX_READ, &amp;r));
      defer(txn_close, r);
      page_t p = {.page_num = page};
      assert(txn_get_page(&amp;r, &amp;p));
      assert(strcmp("Hello Remotely", p.address) == 0);
    }
  }

  it("log shipping with encryption, destination without key") {
    db_t src, dst;
    uint64_t page;

    char key[32];
    randombytes_buf(key, 32);
    {
      db_options_t dst_options = {.minimum_size = 4 * 1024 * 1024,
          .flags = db_flags_log_shipping_target};
      assert(db_create("/tmp/db/try-dst", &amp;dst_options, &amp;dst));
      defer(db_close, dst);

      db_and_error_state_t state = {.db = &amp;dst};
      db_options_t src_options   = {.minimum_size = 4 * 1024 * 1024,
          .wal_write_callback                   = ship_wal_logs,
          .wal_write_callback_state             = &amp;state};
      memcpy(src_options.encryption_key, key, 32);
      assert(db_create("/tmp/db/try-src", &amp;src_options, &amp;src));
      defer(db_close, src);

      {
        txn_t w;
        assert(txn_create(&amp;src, TX_WRITE, &amp;w));
        defer(txn_close, w);
        page_t p = {.number_of_pages = 1};
        assert(txn_allocate_page(&amp;w, &amp;p, 0));
        page                                 = p.page_num;
        p.metadata-&gt;overflow.page_flags      = page_flags_overflow;
        p.metadata-&gt;overflow.number_of_pages = 1;
        strcpy(p.address, "Hello Remotely");
        assert(txn_commit(&amp;w));
      }
    }
    {
      db_options_t dst_options = {.minimum_size = 4 * 1024 * 1024,
          .flags = db_flags_log_shipping_target};
      memcpy(dst_options.encryption_key, key, 32);
      assert(db_create("/tmp/db/try-dst", &amp;dst_options, &amp;dst));
      defer(db_close, dst);

      txn_t r;
      assert(txn_create(&amp;dst, TX_READ, &amp;r));
      defer(txn_close, r);
      page_t p = {.page_num = page};
      assert(txn_get_page(&amp;r, &amp;p));
      assert(strcmp("Hello Remotely", p.address) == 0);
    }
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
    <ul style="list-style-type: none;">
        <li><a class="footer-text" href="../index.html">Table of contents</a></li>
        <li><a class="footer-text" href="./ch12.html">Previous chapter</a></li>
        <li><a class="footer-text" href="./ch14.html">Next chapter</a></li>
    </ul>
</div>
</body>
</html>